<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@zimtsui/startable</title><meta name="description" content="Documentation for @zimtsui/startable"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar">
<div class="tsd-toolbar-contents container">
<div class="table-cell" id="tsd-search" data-base=".">
<div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div>
<div class="field">
<div id="tsd-toolbar-links"></div></div>
<ul class="results">
<li class="state loading">Preparing search index...</li>
<li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@zimtsui/startable</a></div>
<div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></svg></a></div></div></header>
<div class="container container-main">
<div class="col-8 col-content">
<div class="tsd-page-title">
<h2>@zimtsui/startable</h2></div>
<div class="tsd-panel tsd-typography">
<a href="#startable" id="startable" style="color: inherit; text-decoration: none;">
  <h1>Startable</h1>
</a>
<p>Startable 是一个 JavaScript 的 Daemon 生命周期管理器。初衷是为了适配阿里开源 Node.js 进程管理器 <a href="https://github.com/midwayjs/pandora">Pandora</a>。</p>
<p><a href="./docs/index.html">API</a></p>

<a href="#任务和服务" id="任务和服务" style="color: inherit; text-decoration: none;">
  <h2>任务和服务</h2>
</a>
<ul>
<li><p>任务/Job/Task</p>
<p>  运行时间与性能有关，性能越强，运行时间越短。</p>
<p>  例如，批处理脚本。</p>
</li>
<li><p>服务</p>
<ul>
<li><p>事件触发式/回调式</p>
<p>  服务占有线程，用户被调用。俗称 Daemon。</p>
<p>  有可能自己挂掉。例如 Node.js 中一个 TCP 连接，就是一个事件触发式服务。他本身占用协程，如果底层连接断了，会触发事件。</p>
</li>
<li><p>轮询式</p>
<p>  <strong>用户是一个任务</strong>，占有线程，服务被调用。俗称资源。</p>
<p>  不会自己挂掉。例如 C 语言中一个文件描述符就是一个轮询式服务，向用户提供文件访问服务。他本身不占用线程，如果某时刻底层资源挂了，只要不去读这个文件描述符，用户态就永远不知道底层资源挂了。</p>
</li>
</ul>
</li>
</ul>

<a href="#转换" id="转换" style="color: inherit; text-decoration: none;">
  <h3>转换</h3>
</a>
<p>轮询式不可多路复用，将轮询式转换为事件触发式</p>
<ul>
<li>新开一个线程写一个循环</li>
<li>libev</li>
</ul>
<p>将事件触发式转换为轮询式</p>
<ul>
<li>Semaphore queue</li>
</ul>
<p>将轮询任务，即轮询式服务的用户，转换为可启停的事件触发式服务</p>
<ul>
<li>Pollerloop</li>
</ul>
<p>将轮询任务，即轮询式服务的用户，转换为可启停的轮询式服务</p>
<ul>
<li>Generator</li>
</ul>
<p>JavaScript 协程是协作式调度，与抢占式调度相比的优势在于状态切换的过程具有天然事务性。抢占式切换状态需要给状态加锁。</p>

<a href="#服务之间的依赖性" id="服务之间的依赖性" style="color: inherit; text-decoration: none;">
  <h3>服务之间的依赖性</h3>
</a>
<p>一个服务可能依赖多个其他服务，可以是聚合也可以是组合。只有子服务全部离开启动阶段，父服务才算离开启动阶段；只要有一个子服务进入停止阶段，父服务就算进入停止阶段。</p>

<a href="#服务启停的事务性" id="服务启停的事务性" style="color: inherit; text-decoration: none;">
  <h3>服务启停的事务性</h3>
</a>
<p>启停过程本身可能发生异常而失败比如一个 TCP Socket 连接时就没连上。</p>
<p>C 语言打开一个文件的过程由内核确保事务性，打开失败等于没开。而用户态服务的启动过程如果失败了，内部组件可能开了一半，处于不一致状态，因此打开失败后也必须关闭。</p>

<a href="#服务启停的异步性" id="服务启停的异步性" style="color: inherit; text-decoration: none;">
  <h3>服务启停的异步性</h3>
</a>
<p>服务可以有一个异步的启动和停止过程，用户需要等待启停过程结束。</p>
<p>例如一个 TCP Socket 有一个异步的握手和挥手的过程。</p>

<a href="#daemon-启停的自发性" id="daemon-启停的自发性" style="color: inherit; text-decoration: none;">
  <h3>Daemon 启停的自发性</h3>
</a>
<p>Daemon 停止过程可能自发开始。</p>
<p>例如比如一个 TCP Socket 可能因可能因网络中断而离开了「正常提供服务中」的状态，不得不自发开始停止过程。</p>
<p>当然资源底层也可能随时挂掉，但接口层面不知道，挂掉之后继续使用会抛出定义的错误。而 Daemon 底层挂掉之后，接口层会被通知，挂掉之后继续使用会导致未定义的后果。</p>

<a href="#daemon-的工程难度" id="daemon-的工程难度" style="color: inherit; text-decoration: none;">
  <h3>Daemon 的工程难度</h3>
</a>
<p>写 Daemon 的麻烦之处在于</p>
<ul>
<li>父服务处于启动阶段中时，某个已经离开启动阶段的子服务挂掉了，并调用了父服务的停止函数。最终导致父服务在启动阶段被调用了停止函数。</li>
<li>父服务处于停止阶段中时，某个还未进入停止阶段的子服务挂掉了，并调用了父服务的停止函数。最终导致父服务在停止阶段被重复调用了停止函数。</li>
</ul>
<p>底层资源可能在 Daemon 生命周期的任何阶段挂掉，可能在启动停止过程中挂掉。</p>
<p>Startable 是 JavaScript 的 Daemon 生命周期管理器，有了他你就可以把心思花在业务逻辑上。</p>
<p>当然 Startable 也可以管理资源，毕竟资源可以被看成永不自发停止的 Daemon。</p>

<a href="#best-practices" id="best-practices" style="color: inherit; text-decoration: none;">
  <h2>Best practices</h2>
</a>
<p>当自己发生内部错误时，就应当调用自己的 <code>.stop()</code>，因为在语义上，此时自己已经结束了「正常提供服务中」的状态。</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Daemon</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">someComponent</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;some fatal error&#39;</span><span class="hl-1">, </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStart</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {}</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStop</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-4">rawStop</span><span class="hl-1">() {}</span><br/><span class="hl-1">}</span>
</code></pre>
<p><code>.start()</code> 可以接受一个 onStopping 钩子作为回调，用于在停止过程开始时通知外部。当停止过程开始时会先同步地调用这个回调，并将你填进 <code>.stop()</code> 的参数传递给这个回调。你可以自行定义这个 Error 参数的语义，然后在回调中根据参数判断停止的原因。</p>
<p>如果是自发停止则传参，如果是从外部被动停止则不传参，这样就可以在回调中根据参数是否存在来判断是不是自发停止。</p>
<pre><code class="language-ts"><span class="hl-6">// main coroutine</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-7">daemon</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Daemon</span><span class="hl-1">();</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">startDaemon</span><span class="hl-1">(){</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-3">err</span><span class="hl-1">) </span><span class="hl-4">handleRunningException</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">);</span><br/><span class="hl-1">    }).</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStartingException</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">stopDaemon</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#composition" id="composition" style="color: inherit; text-decoration: none;">
  <h3>Composition</h3>
</a>
<p>如果一个 Startable 依赖于其内部的其他 Startable，即</p>
<ul>
<li>当所有儿子的 <code>.start()</code> 都 fulfilled 后，爸爸的 <code>.start()</code> 才能 fulfilled。因为在语义上，只有当所有儿子都进入「正常提供服务中」的状态时，爸爸才算进入「正常提供服务中」的状态。</li>
<li>只要有一个儿子自发开始停止过程，即这个儿子运行了他自己的 <code>.stop()</code>，那么爸爸也必须立即开始停止过程。因为在语义上，只要有一个儿子离开了「正常提供服务中」的状态，爸爸就算不上「正常提供服务中」的状态了。</li>
</ul>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Parent</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child1</span><span class="hl-1">: </span><span class="hl-2">Daemon</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child2</span><span class="hl-1">: </span><span class="hl-2">Daemon</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    </span><span class="hl-0">protected</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">(): </span><span class="hl-2">Promise</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">child1</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">child2</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-0">protected</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStop</span><span class="hl-1">(): </span><span class="hl-2">Promise</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">child2</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">child1</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
<ul>
<li>如果在 child2 启动过程中，已经启动完成的 child1 开始自发停止，那么 child1 会通过 onStopping 回调调用 parent 的 <code>.stop()</code>，此时 parent 处于 STARTING 状态，导致 parent 的启动过程 rejected。在语义上，一个 Daemon 启动过程中，他依赖的儿子挂了，这个 Daemon 的启动过程也确实算不上成功，因此语义与实现是一致的。</li>
<li>如果调用 <code>$(parent).stop()</code>，<code>$(parent).stop()</code> 会调用 <code>$(child).stop()</code>，<code>$(child).stop()</code> 会通过 onStopping 回调再次调用 <code>$(parent).stop()</code>，不过此时 parent 处于 STOPPING 状态，parent 内部的 <code>.rawStop</code> 实现不会被调用两次。</li>
</ul>

<a href="#aggregation" id="aggregation" style="color: inherit; text-decoration: none;">
  <h3>Aggregation</h3>
</a>
<p>一个 Startable 的依赖也可能是外部注入的 Startable。</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Daemon</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-3">dep</span><span class="hl-1">: </span><span class="hl-2">Daemon</span><span class="hl-1">,</span><br/><span class="hl-1">    ) { }</span><br/><br/><span class="hl-1">    </span><span class="hl-0">protected</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">dep</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#bad-practices" id="bad-practices" style="color: inherit; text-decoration: none;">
  <h2>Bad practices</h2>
</a>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Daemon</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">someComponent</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;some fatal error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">handleRunningException</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">); </span><span class="hl-6">// don&#39;t do this.</span><br/><span class="hl-1">            </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-7">daemon</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Daemon</span><span class="hl-1">();</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">startDaemon</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(() </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">)</span><br/><span class="hl-1">    }).</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStartingException</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">stopDaemon</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">}</span>
</code></pre>
<p>这个例子的问题在于，一个 Daemon 中出现的一个让你不得不自发停止的致命错误，那么对这个异常的 handle 代码不应写在类定义的里面，因为这个 handle 过程在语义上不属于这个对象的职责，不是你的职责却非要越俎代庖，违反了迪米特法则。</p>
<hr>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Daemon</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">someComponent</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;some fatal error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">)</span><br/><span class="hl-1">                .</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">); </span><span class="hl-6">// don&#39;t do this.</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-7">daemon</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Daemon</span><span class="hl-1">();</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">startDaemon</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-3">err</span><span class="hl-1">) </span><span class="hl-4">handleRunningException</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">);</span><br/><span class="hl-1">    }).</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStartingException</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">stopDaemon</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">); </span><span class="hl-6">// don&#39;t do this.</span><br/><span class="hl-1">}</span>
</code></pre>
<p>这个例子的问题在于，一个 Daemon 的自发停止过程发生异常而失败，这个异常的 handle 代码不应写在 <code>.stop()</code> 的 caller 中，因为 caller 有很多个，不得不写很多遍。</p>

<a href="#协程安全" id="协程安全" style="color: inherit; text-decoration: none;">
  <h2>协程安全</h2>
</a>
<p>写多线程要考虑线程同步问题，一个线程内的连续代码并不一定在连续时间片中运行，他们之间可能插入了其他时间片跑着其他线程的代码。同理，写多协程也要考虑协程同步问题，一个协程内的 await 两侧的连续代码并不一定在连续的事件循环中运行，他们之间可能插入了其他事件循环跑着其他协程的代码。</p>
<p>Startable 用 Promise 搞来搞去，必然存在协程同步问题。例如如果一个 Startable 被多个协程控制，那么在任意一个协程内</p>
<pre><code class="language-ts"><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">();</span><br/><span class="hl-3">console</span><span class="hl-1">.</span><span class="hl-4">log</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">daemon</span><span class="hl-1">).</span><span class="hl-4">getReadyState</span><span class="hl-1">());</span>
</code></pre>
<p>的结果不一定是 STARTED，完全有可能是 STOPPING 或 STOPPED。</p>

<a href="#健壮性" id="健壮性" style="color: inherit; text-decoration: none;">
  <h2>健壮性</h2>
</a>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Daemon</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child</span><span class="hl-1">: </span><span class="hl-2">Daemon</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStart</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">child</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-3">somePromise</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-3">child</span><span class="hl-1">.</span><span class="hl-4">someMethod</span><span class="hl-1">(); </span><span class="hl-6">// child may be STOPPING.</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>因此 Daemon 的所有公共方法务必确保健壮性，要么返回正确结果，要么抛出，不能导致不一致的不可预料结果。</p>
<p>所有 async 公共方法，如果过程中进入 STOPPING，同样要么返回正确结果，要么抛出。</p>
</div></div>
<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
<div class="tsd-navigation settings">
<details class="tsd-index-accordion"><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Settings</h3></summary>
<div class="tsd-accordion-details">
<div class="tsd-filter-visibility">
<h4 class="uppercase">Member Visibility</h4><form>
<ul id="tsd-filter-options">
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div>
<div class="tsd-theme-toggle">
<h4 class="uppercase">Theme</h4><select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div>
<nav class="tsd-navigation primary">
<details class="tsd-index-accordion" open><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Modules</h3></summary>
<div class="tsd-accordion-details">
<ul>
<li class="current selected"><a href="modules.html">@zimtsui/startable</a>
<ul></ul></li></ul></div></details></nav>
<nav class="tsd-navigation secondary menu-sticky">
<ul>
<li class="tsd-kind-enum"><a href="enums/ReadyState.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-enum)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-8-path"></rect><path d="M9.45 16V7.24H14.49V8.224H10.518V10.936H14.07V11.908H10.518V15.016H14.49V16H9.45Z" fill="var(--color-text)" id="icon-8-text"></path></svg>Ready<wbr/>State</a></li>
<li class="tsd-kind-class"><a href="classes/Startable.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-class)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-128-path"></rect><path d="M11.898 16.1201C11.098 16.1201 10.466 15.8961 10.002 15.4481C9.53803 15.0001 9.30603 14.3841 9.30603 13.6001V9.64012C9.30603 8.85612 9.53803 8.24012 10.002 7.79212C10.466 7.34412 11.098 7.12012 11.898 7.12012C12.682 7.12012 13.306 7.34812 13.77 7.80412C14.234 8.25212 14.466 8.86412 14.466 9.64012H13.386C13.386 9.14412 13.254 8.76412 12.99 8.50012C12.734 8.22812 12.37 8.09212 11.898 8.09212C11.426 8.09212 11.054 8.22412 10.782 8.48812C10.518 8.75212 10.386 9.13212 10.386 9.62812V13.6001C10.386 14.0961 10.518 14.4801 10.782 14.7521C11.054 15.0161 11.426 15.1481 11.898 15.1481C12.37 15.1481 12.734 15.0161 12.99 14.7521C13.254 14.4801 13.386 14.0961 13.386 13.6001H14.466C14.466 14.3761 14.234 14.9921 13.77 15.4481C13.306 15.8961 12.682 16.1201 11.898 16.1201Z" fill="var(--color-text)" id="icon-128-text"></path></svg>Startable</a></li>
<li class="tsd-kind-class"><a href="classes/StateError.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-128-path"></use><use href="#icon-128-text"></use></svg>State<wbr/>Error</a></li>
<li class="tsd-kind-interface"><a href="interfaces/OnStopping.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-interface)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-256-path"></rect><path d="M9.51 16V15.016H11.298V8.224H9.51V7.24H14.19V8.224H12.402V15.016H14.19V16H9.51Z" fill="var(--color-text)" id="icon-256-text"></path></svg>On<wbr/>Stopping</a></li>
<li class="tsd-kind-interface"><a href="interfaces/RawStart.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-256-path"></use><use href="#icon-256-text"></use></svg>Raw<wbr/>Start</a></li>
<li class="tsd-kind-interface"><a href="interfaces/RawStop.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-256-path"></use><use href="#icon-256-text"></use></svg>Raw<wbr/>Stop</a></li>
<li class="tsd-kind-function"><a href="functions/_.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-function)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-64-path"></rect><path d="M9.39 16V7.24H14.55V8.224H10.446V11.128H14.238V12.112H10.47V16H9.39Z" fill="var(--color-text)" id="icon-64-text"></path></svg>$</a></li>
<li class="tsd-kind-function"><a href="functions/AsRawStart.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-64-path"></use><use href="#icon-64-text"></use></svg>As<wbr/>Raw<wbr/>Start</a></li>
<li class="tsd-kind-function"><a href="functions/AsRawStop.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-64-path"></use><use href="#icon-64-text"></use></svg>As<wbr/>Raw<wbr/>Stop</a></li></ul></nav></div></div>
<div class="container tsd-generator">
<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div>
<div class="overlay"></div><script src="assets/main.js"></script></body></html>